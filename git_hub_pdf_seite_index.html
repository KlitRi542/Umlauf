<!doctype html>
<html lang="de">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>PDF-Sammlung</title>
  <style>
    :root { --bg:#0b0c10; --card:#151821; --muted:#a8b3cf; --text:#e8ecf3; --accent:#5b8cff; }
    *{box-sizing:border-box}
    html,body{margin:0;height:100%;background:var(--bg);color:var(--text);font:16px/1.5 system-ui,-apple-system,Segoe UI,Roboto,Ubuntu,Cantarell,Noto Sans,sans-serif}
    a{color:var(--accent);text-decoration:none}
    a:hover{text-decoration:underline}
    .container{max-width:920px;margin:0 auto;padding:24px}
    header{display:flex;align-items:center;justify-content:space-between;gap:12px;margin-bottom:20px}
    .brand{font-weight:700;font-size:1.25rem}
    .card{background:var(--card);border:1px solid #222836;border-radius:16px;padding:18px}
    .grid{display:grid;grid-template-columns:repeat(auto-fill,minmax(260px,1fr));gap:14px}
    .pdf{display:flex;flex-direction:column;gap:8px;background:#0f1220;border:1px solid #23293a;border-radius:14px;padding:14px}
    .pdf h3{margin:0;font-size:1rem;line-height:1.3}
    .pdf small{color:var(--muted)}
    .toolbar{display:flex;gap:8px;flex-wrap:wrap}
    button,input,select{font:inherit}
    button{cursor:pointer;border:1px solid #2a3448;background:#111628;color:var(--text);padding:10px 14px;border-radius:12px}
    button:hover{background:#16203a}
    input[type="file"]{border:1px dashed #2a3448;border-radius:12px;padding:10px;background:#0d1222}
    .muted{color:var(--muted)}
    .hidden{display:none!important}
    .row{display:flex;gap:12px;flex-wrap:wrap}
    .kbd{font-family:ui-monospace,SFMono-Regular,Menlo,monospace;background:#0f1424;border:1px solid #2a3448;border-radius:8px;padding:2px 6px}
    .badge{display:inline-flex;align-items:center;gap:6px;font-size:.85rem;color:var(--muted)}
    footer{margin-top:28px;color:var(--muted);font-size:.9rem}
    .danger{color:#ff6b6b}
  </style>
</head>
<body>
  <div class="container">
    <header>
      <div class="brand">ðŸ“„ PDFâ€‘Sammlung</div>
      <div class="toolbar">
        <button id="btn-refresh" title="Liste aktualisieren">Aktualisieren</button>
        <button id="btn-admin">Admin</button>
      </div>
    </header>

    <!-- Liste der PDFs -->
    <section class="card">
      <div class="row" style="justify-content:space-between;align-items:center;margin-bottom:10px">
        <h2 style="margin:0">Alle PDFs</h2>
        <div class="badge">Quelle: <span id="repoLabel" class="kbd"></span></div>
      </div>
      <div id="empty" class="muted hidden">Noch keine PDFs hochgeladen.</div>
      <div id="pdfGrid" class="grid"></div>
    </section>

    <!-- Adminbereich -->
    <section id="adminPanel" class="card hidden" style="margin-top:16px">
      <h2 style="margin-top:0">Admin</h2>
      <p class="muted">Nur du kannst Dateien hochladen. Anmeldung: Benutzer <span class="kbd">admin</span> + <strong>Passwort = dein GitHub&nbsp;Personal Access Token</strong> mit Recht <span class="kbd">contents:write</span> fÃ¼r dieses Repository. Das Token wird <u>nicht gespeichert</u> und bleibt nur in dieser Sitzung im Speicher.</p>

      <form id="loginForm" class="row" autocomplete="off">
        <label>Benutzer<br><input id="user" name="user" required placeholder="admin" /></label>
        <label>Passwort (GitHubâ€‘Token)<br><input id="pass" name="pass" type="password" required placeholder="ghp_â€¦" /></label>
        <button type="submit">Anmelden</button>
        <span id="loginStatus" class="muted"></span>
      </form>

      <div id="uploader" class="hidden" style="margin-top:14px">
        <div class="row">
          <input id="file" type="file" accept="application/pdf" />
          <button id="uploadBtn">PDF hochladen</button>
          <span id="uploadStatus" class="muted"></span>
        </div>
        <p class="muted" style="margin-top:8px">Uploads landen im Ordner <span class="kbd">/pdfs</span> im angegebenen Branch.</p>
      </div>
    </section>

    <footer>
      <div>Hinweis: GitHub Pages ist statisch. Der Upload erfolgt Ã¼ber die <a href="https://docs.github.com/rest" target="_blank" rel="noopener">GitHub RESTâ€‘API</a> direkt aus deinem Browser. Nur wer ein gÃ¼ltiges Token hat, kann hochladen.</div>
    </footer>
  </div>

  <script>
    // ==== ðŸ”§ KONFIGURATION ANPASSEN ==========================================
    const GITHUB_OWNER  = "DEIN_GITHUB_USERNAME";   // z.B. "richardklitsch"
    const GITHUB_REPO   = "DEIN_REPO_NAME";         // z.B. "pdf-seite"
    const PAGES_BRANCH  = "main";                    // Branch, aus dem Pages gebaut wird (z.B. "main" oder "gh-pages")
    const CONTENT_DIR   = "pdfs";                    // Zielordner im Repo
    const ADMIN_USER    = "admin";                   // einfacher UI-Nutzername
    // =========================================================================

    const repoLabel = document.getElementById('repoLabel');
    repoLabel.textContent = `${GITHUB_OWNER}/${GITHUB_REPO}@${PAGES_BRANCH}/${CONTENT_DIR}`;

    const state = { token:null };

    const qs = (sel) => document.querySelector(sel);
    const byId = (id) => document.getElementById(id);

    const pdfGrid   = byId('pdfGrid');
    const emptyNote = byId('empty');

    async function listPdfs(){
      pdfGrid.innerHTML = '';
      emptyNote.classList.add('hidden');
      try{
        const url = `https://api.github.com/repos/${GITHUB_OWNER}/${GITHUB_REPO}/contents/${encodeURIComponent(CONTENT_DIR)}?ref=${encodeURIComponent(PAGES_BRANCH)}`;
        const res = await fetch(url, { headers:{ 'Accept':'application/vnd.github+json' } });
        if(res.status===404){ emptyNote.classList.remove('hidden'); return; }
        if(!res.ok) throw new Error(`Fehler beim Laden (${res.status})`);
        const data = await res.json();
        const files = data.filter(x => x.type==='file' && x.name.toLowerCase().endsWith('.pdf'))
                          .sort((a,b)=>a.name.localeCompare(b.name, 'de', {numeric:true}))
        if(files.length===0){ emptyNote.classList.remove('hidden'); return; }
        for(const f of files){
          const card = document.createElement('div');
          card.className = 'pdf';
          const title = document.createElement('h3');
          title.textContent = f.name;
          const meta = document.createElement('small');
          meta.textContent = `${(f.size/1024).toFixed(1)} KB`;
          const link = document.createElement('a');
          // Direktlink, wenn PDFs im gleichen Pages-Build liegen:
          const basePath = window.location.pathname.replace(/\/index\.html$/, '');
          link.href = `${basePath}/${CONTENT_DIR}/${encodeURIComponent(f.name)}`;
          link.target = '_blank';
          link.rel='noopener';
          link.textContent = 'Ã–ffnen';
          card.append(title, meta, link);
          pdfGrid.append(card);
        }
      }catch(err){
        emptyNote.textContent = 'Konnte die Liste nicht laden: ' + err.message;
        emptyNote.classList.remove('hidden');
      }
    }

    async function toBase64(file){
      return new Promise((resolve,reject)=>{
        const reader = new FileReader();
        reader.onload = () => {
          const base64 = btoa(String.fromCharCode(...new Uint8Array(reader.result)));
          resolve(base64);
        };
        reader.onerror = () => reject(reader.error);
        reader.readAsArrayBuffer(file);
      });
    }

    async function uploadPdf(file){
      if(!state.token) throw new Error('Nicht angemeldet.');
      if(!file) throw new Error('Bitte eine PDF auswÃ¤hlen.');
      if(file.type !== 'application/pdf') throw new Error('Nur PDF erlaubt.');

      const filename = file.name.replace(/\s+/g,'_');
      const path = `${CONTENT_DIR}/${filename}`;
      const api = `https://api.github.com/repos/${GITHUB_OWNER}/${GITHUB_REPO}/contents/${encodeURIComponent(path)}`;

      // PrÃ¼fen, ob Datei existiert, um ggf. sha zu setzen (Update statt Create)
      let sha = null;
      const head = await fetch(`${api}?ref=${encodeURIComponent(PAGES_BRANCH)}`, {
        headers:{ 'Accept':'application/vnd.github+json' }
      });
      if(head.ok){ const existing = await head.json(); sha = existing.sha; }

      const content = await toBase64(file);
      const body = {
        message: sha ? `update: ${filename}` : `add: ${filename}`,
        content,
        branch: PAGES_BRANCH,
        sha
      };

      const res = await fetch(api, {
        method:'PUT',
        headers:{
          'Accept':'application/vnd.github+json',
          'Authorization': `Bearer ${state.token}`
        },
        body: JSON.stringify(body)
      });

      if(!res.ok){
        const t = await res.text();
        throw new Error(`Upload fehlgeschlagen (${res.status}): ${t}`);
      }

      return await res.json();
    }

    // UI Handlers
    byId('btn-refresh').addEventListener('click', listPdfs);

    byId('btn-admin').addEventListener('click', ()=>{
      byId('adminPanel').classList.toggle('hidden');
    });

    byId('loginForm').addEventListener('submit', async (e)=>{
      e.preventDefault();
      const user = byId('user').value.trim();
      const pass = byId('pass').value.trim();
      const status = byId('loginStatus');

      if(user !== ADMIN_USER){ status.textContent = 'Falscher Benutzer.'; return; }
      if(!pass){ status.textContent = 'Token fehlt.'; return; }

      // Minimal-Check: Token valid?
      status.textContent = 'PrÃ¼fe Tokenâ€¦';
      const ping = await fetch('https://api.github.com/user', {
        headers:{ 'Accept':'application/vnd.github+json', 'Authorization': `Bearer ${pass}` }
      });
      if(!ping.ok){ status.textContent = 'Token ungÃ¼ltig oder ohne Rechte.'; return; }

      state.token = pass; // im Speicher behalten (nicht persistiert)
      status.textContent = 'Angemeldet.';
      byId('uploader').classList.remove('hidden');
    });

    byId('uploadBtn').addEventListener('click', async ()=>{
      const file = byId('file').files[0];
      const status = byId('uploadStatus');
      status.textContent = 'Lade hochâ€¦';
      try{
        await uploadPdf(file);
        status.textContent = 'Fertig. Liste wird aktualisiertâ€¦';
        await listPdfs();
        byId('file').value = '';
        status.textContent = 'Upload erfolgreich.';
      }catch(err){
        status.innerHTML = `<span class="danger">${err.message}</span>`;
      }
    });

    // Beim ersten Laden PDFs listen
    listPdfs();
  </script>
</body>
</html>
